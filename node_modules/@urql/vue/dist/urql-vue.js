var e = require("@urql/core");

var r = require("vue");

var u = require("wonka");

function _extends() {
  return (_extends = Object.assign || function(e) {
    for (var r = 1; r < arguments.length; r++) {
      var u = arguments[r];
      for (var t in u) {
        if (Object.prototype.hasOwnProperty.call(u, t)) {
          e[t] = u[t];
        }
      }
    }
    return e;
  }).apply(this, arguments);
}

function install(u, t) {
  var n;
  if (!r.isRef(t)) {
    n = r.ref(t instanceof e.Client ? t : new e.Client(t));
  } else {
    n = t;
  }
  u.provide("$urql", n);
}

function useClient() {
  if ("production" !== process.env.NODE_ENV && !r.getCurrentInstance()) {
    throw new Error("use* functions may only be called during the `setup()` or other lifecycle hooks.");
  }
  var e = r.inject("$urql");
  if ("production" !== process.env.NODE_ENV && !e) {
    throw new Error("No urql Client was provided. Did you forget to install the plugin or call `provideClient` in a parent?");
  }
  return e;
}

function unwrapPossibleProxy(e) {
  return e && r.isRef(e) ? e.value : e;
}

var t = {
  flush: "pre"
};

function callUseQuery(n, a, i) {
  if (void 0 === a) {
    a = useClient();
  }
  if (void 0 === i) {
    i = [];
  }
  var s = r.reactive(n);
  var o = r.ref();
  var l = r.ref(!1);
  var c = r.ref(!1);
  var v = r.ref();
  var f = r.ref();
  var p = r.ref();
  var d = r.isRef(n.pause) ? n.pause : r.ref(!!n.pause);
  var b = r.ref(e.createRequest(s.query, unwrapPossibleProxy(s.variables)));
  var h = r.ref();
  i.push(r.watchEffect((function() {
    var r = e.createRequest(s.query, unwrapPossibleProxy(s.variables));
    if (b.value.key !== r.key) {
      b.value = r;
    }
  }), t));
  i.push(r.watchEffect((function() {
    h.value = !d.value ? a.value.executeQuery(b.value, _extends({}, {
      requestPolicy: s.requestPolicy
    }, s.context)) : void 0;
  }), t));
  var y = {
    data: o,
    stale: l,
    error: v,
    operation: f,
    extensions: p,
    fetching: c,
    isPaused: d,
    executeQuery: function executeQuery(e) {
      var r = h.value = a.value.executeQuery(b.value, _extends({}, {
        requestPolicy: s.requestPolicy
      }, s.context, e));
      return _extends({}, x, {
        then: function then(e, t) {
          return new Promise((function(e) {
            var t = !1;
            var n = u.subscribe((function() {
              if (!y.fetching.value && !y.stale.value) {
                if (n) {
                  n.unsubscribe();
                }
                t = !0;
                e(y);
              }
            }))(r);
            if (t) {
              n.unsubscribe();
            }
          })).then(e, t);
        }
      });
    },
    pause: function pause() {
      d.value = !0;
    },
    resume: function resume() {
      d.value = !1;
    }
  };
  i.push(r.watchEffect((function(e) {
    if (h.value) {
      c.value = !0;
      l.value = !1;
      e(u.subscribe((function(e) {
        o.value = e.data;
        l.value = !!e.stale;
        c.value = !1;
        v.value = e.error;
        f.value = e.operation;
        p.value = e.extensions;
      }))(u.onEnd((function() {
        c.value = !1;
        l.value = !1;
      }))(h.value)).unsubscribe);
    } else {
      c.value = !1;
      l.value = !1;
    }
  }), {
    flush: "sync"
  }));
  var x = _extends({}, y, {
    then: function then(e, r) {
      return new Promise((function(e) {
        if (!h.value) {
          return e(y);
        }
        var r = !1;
        var t = u.subscribe((function() {
          if (!y.fetching.value && !y.stale.value) {
            if (t) {
              t.unsubscribe();
            }
            r = !0;
            e(y);
          }
        }))(h.value);
        if (r) {
          t.unsubscribe();
        }
      })).then(e, r);
    }
  });
  return x;
}

function callUseMutation(t, n) {
  if (void 0 === n) {
    n = useClient();
  }
  var a = r.ref();
  var i = r.ref(!1);
  var s = r.ref(!1);
  var o = r.ref();
  var l = r.ref();
  var c = r.ref();
  return {
    data: a,
    stale: i,
    fetching: s,
    error: o,
    operation: l,
    extensions: c,
    executeMutation: function executeMutation(r, v) {
      s.value = !0;
      return u.toPromise(u.take(1)(n.value.executeMutation(e.createRequest(t, unwrapPossibleProxy(r)), v || {}))).then((function(e) {
        a.value = e.data;
        i.value = !!e.stale;
        s.value = !1;
        o.value = e.error;
        l.value = e.operation;
        c.value = e.extensions;
        return e;
      }));
    }
  };
}

var n = {
  flush: "pre"
};

function callUseSubscription(t, a, i, s) {
  if (void 0 === i) {
    i = useClient();
  }
  if (void 0 === s) {
    s = [];
  }
  var o = r.reactive(t);
  var l = r.ref();
  var c = r.ref(!1);
  var v = r.ref(!1);
  var f = r.ref();
  var p = r.ref();
  var d = r.ref();
  var b = r.ref(a);
  var h = r.isRef(t.pause) ? t.pause : r.ref(!!t.pause);
  var y = r.ref(e.createRequest(o.query, unwrapPossibleProxy(o.variables)));
  var x = r.ref();
  s.push(r.watchEffect((function() {
    var r = e.createRequest(o.query, unwrapPossibleProxy(o.variables));
    if (y.value.key !== r.key) {
      y.value = r;
    }
  }), n));
  s.push(r.watchEffect((function() {
    x.value = !h.value ? i.value.executeSubscription(y.value, _extends({}, o.context)) : void 0;
  }), n));
  s.push(r.watchEffect((function(e) {
    if (x.value) {
      v.value = !0;
      e(u.subscribe((function(e) {
        v.value = !0;
        l.value = void 0 !== e.data ? "function" == typeof b.value ? b.value(l.value, e.data) : e.data : e.data, 
        f.value = e.error;
        d.value = e.extensions;
        c.value = !!e.stale;
        p.value = e.operation;
      }))(u.onEnd((function() {
        v.value = !1;
      }))(x.value)).unsubscribe);
    } else {
      v.value = !1;
    }
  }), n));
  var w = {
    data: l,
    stale: c,
    error: f,
    operation: p,
    extensions: d,
    fetching: v,
    isPaused: h,
    executeSubscription: function executeSubscription(e) {
      x.value = i.value.executeSubscription(y.value, _extends({}, o.context, e));
      return w;
    },
    pause: function pause() {
      h.value = !0;
    },
    resume: function resume() {
      h.value = !1;
    }
  };
  return w;
}

exports.default = install;

exports.install = install;

exports.provideClient = function provideClient(u) {
  var t;
  if (!r.isRef(u)) {
    t = r.ref(u instanceof e.Client ? u : new e.Client(u));
  } else {
    t = u;
  }
  r.provide("$urql", t);
  return t.value;
};

exports.useClientHandle = function useClientHandle() {
  var e = useClient();
  var u = [];
  r.onBeforeUnmount((function() {
    var e;
    while (e = u.shift()) {
      e();
    }
  }));
  var t = {
    client: e.value,
    useQuery: function useQuery(r) {
      return callUseQuery(r, e, u);
    },
    useSubscription: function useSubscription(r, t) {
      return callUseSubscription(r, t, e, u);
    },
    useMutation: function useMutation(r) {
      return callUseMutation(r, e);
    }
  };
  if ("production" !== process.env.NODE_ENV) {
    r.onMounted((function() {
      _extends(t, {
        useQuery: function useQuery(t) {
          if ("production" !== process.env.NODE_ENV && !r.getCurrentInstance()) {
            throw new Error("`handle.useQuery()` should only be called in the `setup()` or a lifecycle hook.");
          }
          return callUseQuery(t, e, u);
        },
        useSubscription: function useSubscription(t, n) {
          if ("production" !== process.env.NODE_ENV && !r.getCurrentInstance()) {
            throw new Error("`handle.useSubscription()` should only be called in the `setup()` or a lifecycle hook.");
          }
          return callUseSubscription(t, n, e, u);
        }
      });
    }));
  }
  return t;
};

exports.useMutation = function useMutation(e) {
  return callUseMutation(e);
};

exports.useQuery = function useQuery(e) {
  return callUseQuery(e);
};

exports.useSubscription = function useSubscription(e, r) {
  return callUseSubscription(e, r);
};

Object.keys(e).forEach((function(r) {
  if ("default" !== r && !exports.hasOwnProperty(r)) {
    exports[r] = e[r];
  }
}));
//# sourceMappingURL=urql-vue.js.map
